<mat-card class="user-card container-item">
  <mat-card-header>
    @if (user.role === roleTypes.ADMIN) {
      <mat-icon
        mat-card-avatar
        matListIcon
        mat-card-avatar
        class="avatar"
        >
        person
      </mat-icon>
    }
    @if (user.role === roleTypes.USER) {
      <mat-icon matListIcon mat-card-avatar class="avatar">
        person_outline
      </mat-icon>
    }
    <mat-card-title>{{ user.name }}</mat-card-title>
    @if (user.role === roleTypes.ADMIN) {
      <mat-card-subtitle i18n="@@user type administrator">
      Administrator
    </mat-card-subtitle>
    }
    @if (user.role === roleTypes.USER) {
      <mat-card-subtitle i18n="@@user type user">
      User
    </mat-card-subtitle>
    }
  </mat-card-header>

  @if (loading) {
    <mat-spinner color="primary" diameter="40"></mat-spinner>
  }

  @if (!loading) {
    <span>
      <mat-divider></mat-divider>
      <!-- Cards -->
      <mat-card-content>
        <mat-card-title i18n="@@user cards">Cards</mat-card-title>
        @for (card of cards; track card) {
          <mat-list role="list">
            <mat-checkbox
              color="primary"
              [checked]="card.enabled"
              [disabled]="!canManageCards || disabled"
              (change)="toggleCardEnabled(card.id)"
              >
              <mat-icon [className]="card.enabled ? 'card-enabled' : 'card-disabled'">
                credit_card
              </mat-icon>
              <span [className]="!card.enabled ? 'card-description-disabled' : ''">
                {{ card.description }}
              </span>
            </mat-checkbox>
            <button
              mat-icon-button
              color="warn"
              [disabled]="!canManageCards || disabled"
              (click)="openDeleteCardDialog(card.id)"
              >
              <mat-icon>delete</mat-icon>
            </button>
          </mat-list>
        }
        @if (cards.length === 0 && !registeringCard) {
          <mat-card-subtitle i18n="@@user no cards">
        No cards registered
      </mat-card-subtitle>
        }
        @if (registeringCard) {
          <mat-progress-spinner
            color="primary"
            mode="indeterminate"
            diameter="20"
          ></mat-progress-spinner>
        }
      </mat-card-content>
      <mat-divider></mat-divider>
      <!-- Registration code -->
      <mat-card-content>
        <mat-card-title i18n="@@user device registration code">Device registration code</mat-card-title>
        @if (user.hasRegistrationCode) {
          <div class="registration">
            <mat-icon class="entry">key</mat-icon>
            <span i18n="@@user registration">Expires on:</span>
            @if (user.registrationExpiry) {
              <span>{{ user.registrationExpiry }}</span>
            }
            @if (!user.registrationExpiry) {
              <span i18n="@@user expiry never">never</span>
            }
            <button
              mat-icon-button
              color="warn"
              [disabled]="!canManageRegistration || disabled"
              (click)="openDeleteRegistrationCodeDialog()"
              >
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        }
        @if (!user.hasRegistrationCode) {
          <mat-card-subtitle i18n="@@user no registration code">
        No registration code
      </mat-card-subtitle>
        }
      </mat-card-content>
      @if (user.role === roleTypes.ADMIN) {
        <mat-divider></mat-divider>
      }
      <!-- SSH key -->
      @if (user.role === roleTypes.ADMIN) {
        <mat-card-content>
          <mat-card-title i18n="@@user ssh key">SSH key</mat-card-title>
          @if (hasSshKey) {
            <div class="ssh">
              <mat-icon class="entry">terminal</mat-icon>
              <button
                mat-icon-button
                color="warn"
                [disabled]="!canManageSshKeys || disabled"
                (click)="openDeleteSshKeyDialog()"
                >
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          }
          @if (!hasSshKey) {
            <mat-card-subtitle i18n="@@user no ssh key">No SSH key</mat-card-subtitle>
          }
        </mat-card-content>
      }
      <!-- MCP token -->
      @if (user.role === roleTypes.ADMIN && hasMCPToken !== null) {
        <mat-divider></mat-divider>
      }
      @if (user.role === roleTypes.ADMIN && hasMCPToken !== null) {
        <mat-card-content>
          <mat-card-title i18n="@@mcp token">MCP token</mat-card-title>
          @if (hasMCPToken === true) {
            <div>
              <mat-icon class="entry">vpn_key</mat-icon>
              <button
                mat-icon-button
                color="warn"
                [disabled]="!canManageMCP || disabled"
                (click)="removeMCPToken()"
                >
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          }
          @if (hasMCPToken === false) {
            <mat-card-subtitle i18n="@@user no mcp token">
        No MCP token
      </mat-card-subtitle>
          }
        </mat-card-content>
      }
      <!-- Comment -->
      @if (user.comment) {
        <mat-divider></mat-divider>
      }
      @if (user.comment) {
        <mat-card-content>
          <p>{{ user.comment }}</p>
        </mat-card-content>
      }
      @if (biometricAvailable) {
        <mat-divider></mat-divider>
      }
      <!-- Biometric login -->
      @if (biometricAvailable) {
        <mat-card-content>
          <mat-card-title i18n="@@user biometric login">Biometric login</mat-card-title>
          @if (biometricEnabled()) {
            <div class="biometric">
              <mat-icon class="entry">fingerprint</mat-icon>
              <span i18n="@@user biometric enabled">Enabled</span>
            </div>
          }
          @if (!biometricEnabled()) {
            <div class="biometric">
              <mat-icon class="entry">fingerprint</mat-icon>
              <span i18n="@@user biometric disabled">Disabled</span>
            </div>
          }
        </mat-card-content>
      }
    </span>
  }

  <mat-divider></mat-divider>

  <mat-card-actions>
    <button mat-icon-button color="primary" [disabled]="disabled" (click)="navigateToUserEdit()">
      <mat-icon>mode_edit</mat-icon>
    </button>
    <button
      mat-icon-button
      color="warn"
      [disabled]="!canManageUser || disabled"
      (click)="openDeleteUserDialog()"
      >
      <mat-icon>delete</mat-icon>
    </button>

    <button mat-icon-button [matMenuTriggerFor]="menu"><mat-icon>more_vert</mat-icon></button>
    <mat-menu #menu="matMenu">
      <button
        mat-menu-item
        color="primary"
        [disabled]="!canManageRegistration || user.hasRegistrationCode || disabled"
        i18n="@@user register device button"
        (click)="openDeviceRegistrationDialog()"
        >
        Device registration
      </button>
      @if (canManageCards) {
        <button
          mat-menu-item
          color="primary"
          [disabled]="disabled"
          (click)="onClickRegisterCard()"
          i18n="@@user register card button"
          >
        Register card
      </button>
      }
      @if (user.role === roleTypes.ADMIN) {
        <button
          mat-menu-item
          color="primary"
          [disabled]="!canManageSshKeys || hasSshKey || disabled"
          (click)="openSshKeySetupDialog()"
          i18n="@@user generate ssk key"
          >
        Setup SSH key
      </button>
      }
      @if (user.role === roleTypes.ADMIN && hasMCPToken !== null) {
        <button
          mat-menu-item
          color="primary"
          [disabled]="!canManageMCP || disabled || hasMCPToken === true"
          (click)="getMCPToken()"
          i18n="@@user get mcp token"
          >
        Get MCP token
      </button>
      }

      <!-- Biometric login -->
      @if (biometricAvailable) {
        <div>
          <mat-divider></mat-divider>
          @if (!biometricEnabled()) {
            <button
              mat-menu-item
              color="primary"
              [disabled]="disabled"
              (click)="enableBiometricLogin()"
              >
              <span i18n="@@user enable biometric">Enable biometric login</span>
            </button>
          }
          @if (biometricEnabled()) {
            <button
              mat-menu-item
              color="warn"
              [disabled]="disabled"
              (click)="disableBiometricLogin()"
              >
              <span i18n="@@user disable biometric">Disable biometric login</span>
            </button>
          }
        </div>
      }
    </mat-menu>
  </mat-card-actions>
</mat-card>
