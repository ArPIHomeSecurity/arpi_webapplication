<div class="container event-list">
  <mat-expansion-panel>
    <mat-expansion-panel-header>
      <mat-panel-title>
        <span i18n="@@events filter">Filter</span>
      </mat-panel-title>
    </mat-expansion-panel-header>

    <div class="filters">
      <mat-form-field appearance="fill">
        <mat-label i18n="@@events filter arm">Arm type</mat-label>
        <mat-select [(ngModel)]="armType" (ngModelChange)="filterArms()">
          <mat-option [value]="armTypes.UNDEFINED" i18n="@@events arm undefined">
            Undefined
          </mat-option>
          <mat-option [value]="armTypes.AWAY" i18n="@@events arm away">AWAY</mat-option>
          <mat-option [value]="armTypes.STAY" i18n="@@events arm stay">STAY</mat-option>
          <mat-option [value]="armTypes.MIXED" i18n="@@events arm mixed">MIXED</mat-option>
          <mat-option [value]="armTypes.DISARMED" i18n="@@events arm disarmed">DISARMED</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label i18n="@@events filter armed by">Armed by</mat-label>
        <mat-select [(ngModel)]="armedBy" (ngModelChange)="filterArms()">
          <mat-option [value]="0" i18n="@@events undefined">Undefined</mat-option>
          <mat-option [value]="-1" i18n="@@events keypad">Keypad</mat-option>
          @for (user of users; track user) {
            <mat-option [value]="user.id">{{ user.name }}</mat-option>
          }
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label i18n="@@events filter date">Enter a date range</mat-label>
        <mat-date-range-input [rangePicker]="picker">
          <input
            matStartDate
            placeholder="Start date"
            [(ngModel)]="startDate"
            (ngModelChange)="filterArms()"
            />
          <input
            matEndDate
            placeholder="End date"
            [(ngModel)]="endDate"
            (ngModelChange)="filterArms()"
            />
        </mat-date-range-input>
        <mat-hint>YYYY-MM-DD â€“ YYYY-MM-DD</mat-hint>
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-date-range-picker #picker></mat-date-range-picker>
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label i18n="@@events filter alert">Alert happened</mat-label>
        <mat-select [(ngModel)]="hasAlert" (ngModelChange)="filterArms()">
          <mat-option [value]="0" i18n="@@events alert undefined">Undefined</mat-option>
          <mat-option [value]="1" i18n="@@events alert no">No</mat-option>
          <mat-option [value]="2" i18n="@@events alert yes">Yes</mat-option>
        </mat-select>
      </mat-form-field>

      <button
        mat-raised-button
        color="accent"
        (click)="clearFilters()"
        [disabled]="isClearDisabled()"
        (click)="filterArms()"
        i18n="@@events clear filters"
        >
        Clear filters
      </button>
    </div>
  </mat-expansion-panel>

  <mat-paginator
    #paginator
    [length]="armsCount"
    [pageSize]="10"
    [pageSizeOptions]="[5, 10, 25, 100]"
    showFirstLastButtons="true"
    (page)="paginate()"
  ></mat-paginator>

  @if (events) {
    <div class="container-item">
      @if (events && events.length > 0) {
        <div class="container-item">
          @for (event of events; track event) {
            <mat-accordion>
              <mat-expansion-panel [ngClass]="{ alerting: event.alert && !event.alert.endTime }">
                <mat-expansion-panel-header>
                  <mat-panel-title [ngClass]="{ warn: event.disarm?.time == null }">
                    <div class="arm-icon">
                      @if (event.arm?.type == armTypes.AWAY) {
                        <mat-icon matListIcon>
                          directions_walk
                        </mat-icon>
                      }
                      @if (event.arm?.type == armTypes.STAY) {
                        <mat-icon matListIcon>hotel</mat-icon>
                      }
                      @if (event.arm?.type == armTypes.MIXED) {
                        <mat-icon matListIcon>
                          directions_walk
                        </mat-icon>
                      }
                      @if (event.arm?.type == armTypes.MIXED) {
                        <mat-icon matListIcon>hotel</mat-icon>
                      }
                      @if (!event.arm?.type) {
                        <mat-icon matListIcon>verified_user</mat-icon>
                      }
                    </div>
                    @if (event.arm) {
                      <span>{{ event.arm?.time | date: 'longDate' }}</span>
                    }
                    @if (!event.arm) {
                      <span>{{ event.disarm?.time | date: 'longDate' }}</span>
                    }
                    @if (!event.arm && !event.disarm) {
                      <span>
                        {{ event.alert?.startTime | date: 'longDate' }}
                      </span>
                    }
                    @if (event.alert) {
                      <mat-icon
                        [ngStyle]="{ color: event.disarm?.time == null ? 'white' : 'red', margin: '10px' }"
                        >
                        warning
                      </mat-icon>
                    }
                  </mat-panel-title>
                </mat-expansion-panel-header>
                <div class="event-panel-content">
                  <div class="panel basis-12/25" fxFlex.lt-md="100">
                    <span class="title" i18n="@@events properties">Properties</span>
                    <mat-divider></mat-divider>
                    <div class="content">
                      <ul>
                        @if (!event.arm && event.disarm) {
                          <li i18n="@@events sabotage">
                    Sabotage event
                  </li>
                        }
                        @if (event.arm && event.disarm && !event.alert) {
                          <li i18n="@@events arm">
                    Arm event
                  </li>
                        }
                        @if (event.arm && event.disarm && event.alert) {
                          <li i18n="@@events alert">
                    Alert event
                  </li>
                        }
                        @if (event.arm?.userId) {
                          <li>
                            <span i18n="@@events armed by">Armed by</span>
                            {{ getUsername(event.arm?.userId) }}
                            @if (event.arm?.type == armTypes.AWAY) {
                              <span i18n="@@events away">AWAY</span>
                            }
                            @if (event.arm?.type == armTypes.STAY) {
                              <span i18n="@@events stay">STAY</span>
                            }
                          </li>
                        }
                        @if (event.arm?.keypadId) {
                          <li i18n="@@events armed keypad">
                    Armed with keypad
                  </li>
                        }
                        @if (event.alert?.sensors) {
                          <li i18n="@@events sensors">Alerting sensor(s)</li>
                        }
                        <ul>
                          @for (sensor of event.alert?.sensors; track sensor) {
                            <li>
                              {{ sensor.name }}
                              <span>(CH{{ sensor.channel + 1 | number: '2.0-0' }})</span>
                              <span>&semi;&nbsp;</span>
                              <span i18n="@@events delay">delay: {{ sensor.delay }}</span>
                              <span>&semi;&nbsp;</span>
                              @if (sensor.monitorPeriod != null) {
                                <span i18n="@@events sensitivity">
                        sensitivity: {{ sensor.monitorPeriod + 's' }}/{{ sensor.monitorThreshold }}%
                      </span>
                              }
                              @if (sensor.monitorPeriod == null) {
                                <span
                                  i18n="@@events sensitivity instant"
                                  >
                        sensitivity: instant alert
                      </span>
                              }
                              <span>&semi;&nbsp;</span>
                              @if (sensor.silent === true) {
                                <span i18n="@@events silent">silent</span>
                              }
                              @if (sensor.silent === false) {
                                <span i18n="@@events loud">loud</span>
                              }
                            </li>
                          }
                        </ul>
                        @if (event.disarm?.userId) {
                          <li i18n="@@events disarmed by">
                    Disarmed by {{ getUsername(event.disarm?.userId) }}
                  </li>
                        }
                        @if (event.disarm?.keypadId) {
                          <li i18n="@@events disarmed keypad">
                    Disarmed with keypad
                  </li>
                        }
                        @if (
                          !event.disarm?.userId &&
                          !event.disarm?.keypadId &&
                          event.disarm?.time === '2000-01-01 01:00:00'
                          ) {
                          <li
                            [ngClass]="{ warn: event.disarm?.time == null }"
                            i18n="@@events disarmed system"
                            >
                    Disarmed by system
                  </li>
                        }
                        @if (event.alert?.silent) {
                          <li i18n="@@events silent alert">Silent alert</li>
                        }
                      </ul>
                    </div>
                  </div>
                  <div class="panel basis-12/25" fxFlex.lt-md="100">
                    <span class="title" i18n="@@events timeline">Timeline</span>
                    <mat-divider></mat-divider>
                    <div class="content">
                      @for (step of getTimeline(event); track step) {
                        <p
                  [ngClass]="{
                    warn: !environment.production && step.isDefaultDate,
                    hidden: environment.production && step.isDefaultDate
                  }"
                          >
                          {{ step.time }}: {{ step.description }}
                        </p>
                      }
                    </div>
                  </div>
                  <!--div class="panel" fxFlex="100" *ngIf="event['sensorChanges'] && event.sensorChanges.length > 0">->
                  <span class="title" i18n="@@events sensor states">Sensor states VERTICAL</span>
                  <mat-divider></mat-divider>
                  <div class="content">
                    <div class="mat-table">
                      <div class="mat-header-row">
                        <div class="mat-header-cell" i18n="@@events timestamp">Timestamp</div>
                        <div *ngFor="let sensor of event.sensorChanges[0].sensors" class="mat-header-cell">{{sensor.description}}</div>
                      </div>
                      <div class="mat-row" *ngFor="let armSensor of event.sensorChanges">
                        <div class="mat-cell">{{armSensor.timestamp}}</div>
                        <div class="mat-cell" *ngFor="let sensor of armSensor.sensors">{{sensor.delay !== null ? sensor.delay : '-'}}</div>
                      </div>
                    </div>
                  </div>
                </div-->
                @if (event['sensorChanges'] && event.sensorChanges.length > 0) {
                  <div
                    class="panel basis-full"
                    >
                    <span class="title" i18n="@@events sensor states">Sensor states</span>
                    <mat-divider></mat-divider>
                    <div class="content">
                      <div class="mat-table">
                        <div class="mat-header-row">
                          <div class="mat-header-cell"></div>
                          @for (timestamp of getEventTimestamps(event); track timestamp) {
                            <div
                              class="mat-header-cell"
                              [matTooltip]="timestamp"
                              >
                              {{ timestamp }}
                            </div>
                          }
                        </div>
                        @for (index of getEventSensorRange(event); track index) {
                          <div class="mat-row">
                            <div class="mat-cell sensor-name">
                              {{ event.sensorChanges[0].sensors[index].description }}
                              <br />
                              CH{{ event.sensorChanges[0].sensors[index].channel + 1 | number: '2.0-0' }}
                            </div>
                            @for (sensor of getEventSensorStates(event, index); track sensor) {
                              <div class="mat-cell">
                                {{ sensor.enabled && sensor.delay !== null ? sensor.delay : '-' }}
                              </div>
                            }
                          </div>
                        }
                      </div>
                    </div>
                  </div>
                }
              </div>
            </mat-expansion-panel>
          </mat-accordion>
        }
      </div>
    } @else {
      <div class="event-list-xs sm:event-list">
        <h1 class="empty" i18n="@@events empty">No arms/alerts found</h1>
      </div>
    }
  </div>
} @else {
  <div class="loader">
    <mat-spinner></mat-spinner>
  </div>
}
</div>


